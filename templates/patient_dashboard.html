{% extends 'base.html' %} {% block content %}
<h2>Your Appointments</h2>
{% if appointments %}
<div class="card reveal">
  <table class="table">
    <thead>
      <tr>
        <th>#</th>
        <th>Doctor</th>
        <th>Date / Time</th>
        <th>Status</th>
        <th>Transport</th>
      </tr>
    </thead>
    <tbody>
      {% for a in appointments %}
      <tr>
        <td>{{ a.id }}</td>
        <td>
          {{ a.doctor }} {% if a.unread and a.unread > 0 %}
          <span class="notif-badge small">{{ a.unread }}</span>
          {% endif %}
        </td>
        <td>{{ a.datetime }}</td>
        <td>{{ a.status }}</td>
        <td>
          {% if a.transport.requested %} {% if a.transport.pickup_lat and
          a.transport.pickup_lng %}
          <div>
            <a
              target="_blank"
              rel="noopener"
              href="https://www.google.com/maps/search/?api=1&query={{ a.transport.pickup_lat }},{{ a.transport.pickup_lng }}"
              >Pickup: Current location ({{ a.transport.pickup_lat }}, {{
              a.transport.pickup_lng }})</a
            >
          </div>
          {% elif a.transport.pickup_address %}
          <div>
            <a
              target="_blank"
              rel="noopener"
              href="https://www.google.com/maps/search/?api=1&query={{ a.transport.pickup_address|urlencode }}"
              >Pickup: {{ a.transport.pickup_address }}</a
            >
          </div>
          {% else %}
          <div>Pickup: Not provided</div>
          {% endif %}
          <div>Status: {{ a.transport.status }}</div>
          {% else %}
          <div>Self-transport</div>
          {% endif %}
        </td>
        <td>
          <div class="note">Estimated cost: ${{ a.price }}</div>
          <div class="messages">
            {% for m in a.messages %}
            <div
              class="msg {% if m.role == session.user.role %}outgoing{% else %}incoming{% endif %}"
            >
              <div><strong>{{ m.sender }}</strong></div>
              <div class="msg-text">{{ m.text }}</div>
              <div class="ts">{{ m.ts }}</div>
            </div>
            {% endfor %}
          </div>
          <form
            method="post"
            action="{{ url_for('appointment_message') }}"
            style="margin-top: 0.5rem"
          >
            <input type="hidden" name="appointment_id" value="{{ a.id }}" />
            <input
              type="text"
              name="message"
              placeholder="Message admin about this appointment"
              required
            />
            <button class="btn small" type="submit">Send</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No appointments yet. <a href="{{ url_for('book') }}">Book one now</a>.</p>
  {% endif %} {% endblock %}
</div>
