{% extends 'base.html' %} {% block content %}
<h2>Admin Dashboard</h2>
{% if appointments %}
<div class="card reveal">
  <table class="table">
    <thead>
      <tr>
        <th>#</th>
        <th>Patient</th>
        <th>Doctor</th>
        <th>Date/Time</th>
        <th>Appt Status</th>
        <th>Transport</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for a in appointments %}
      <tr>
        <td>{{ a.id }}</td>
        <td>
          {{ a.patient_name }} {% if a.unread and a.unread > 0 %}
          <span class="notif-badge small">{{ a.unread }}</span>
          {% endif %}
        </td>
        <td>{{ a.doctor }}</td>
        <td>{{ a.datetime }}</td>
        <td>{{ a.status }}</td>
        <td>
          {% if a.transport.requested %}
          <div>
            {% if a.transport.pickup_lat and a.transport.pickup_lng %}
            <a
              target="_blank"
              rel="noopener"
              href="https://www.google.com/maps/search/?api=1&query={{ a.transport.pickup_lat }},{{ a.transport.pickup_lng }}"
              >Pickup: Current location ({{ a.transport.pickup_lat }}, {{
              a.transport.pickup_lng }})</a
            >
            {% elif a.transport.pickup_address %}
            <a
              target="_blank"
              rel="noopener"
              href="https://www.google.com/maps/search/?api=1&query={{ a.transport.pickup_address|urlencode }}"
              >Pickup: {{ a.transport.pickup_address }}</a
            >
            {% else %}
            <div>Pickup: Not provided</div>
            {% endif %}
          </div>
          <div>Status: {{ a.transport.status }}</div>
          <div>
            Provider: {{ a.transport.provider.name if a.transport.provider }}
          </div>
          <div class="note">Estimated cost: ${{ a.price }}</div>
          <div class="messages">
            {% for m in a.messages %}
            <div
              class="msg {% if m.role == session.user.role %}outgoing{% else %}incoming{% endif %}"
            >
              <div><strong>{{ m.sender }}</strong></div>
              <div class="msg-text">{{ m.text }}</div>
              <div class="ts">{{ m.ts }}</div>
            </div>
            {% endfor %}
          </div>
          <form
            method="post"
            action="{{ url_for('appointment_message') }}"
            style="margin-top: 0.5rem"
          >
            <input type="hidden" name="appointment_id" value="{{ a.id }}" />
            <input
              type="text"
              name="message"
              placeholder="Message patient about transport"
              required
            />
            <button class="btn small" type="submit">Send</button>
          </form>
          {% else %}
          <div>Not requested</div>
          {% endif %}
        </td>
        <td>
          <form method="post" action="{{ url_for('admin_assign') }}">
            <input type="hidden" name="appointment_id" value="{{ a.id }}" />
            <select name="provider_id">
              {% for p in providers %}
              <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
            <button class="btn small" type="submit">Assign Transport</button>
          </form>
          <form
            method="post"
            action="{{ url_for('admin_update_status') }}"
            style="margin-top: 0.5rem"
          >
            <input type="hidden" name="appointment_id" value="{{ a.id }}" />
            <select name="status">
              <option>Requested</option>
              <option>Confirmed</option>
              <option>Completed</option>
              <option>Cancelled</option>
            </select>
            <button class="btn small" type="submit">Update Status</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<p>No appointments yet.</p>
{% endif %} {% endblock %}
