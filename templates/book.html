{% extends 'base.html' %} {% block content %}
<h2>Book an Appointment</h2>
<div class="card reveal">
  <form id="bookForm" method="post" class="form">
    <label
      >Choose doctor / clinic
      <select name="doctor" required>
        {% for p in providers %}
        <option value="{{ p }}">{{ p }}</option>
        {% endfor %}
      </select>
    </label>
    <label
      >Date
      <input type="date" name="date" required />
    </label>
    <label
      >Time
      <input type="time" name="time" required />
    </label>
    <fieldset>
      <legend>Transport</legend>
      <label
        ><input type="radio" name="needs_transport" value="yes" /> Yes, I need
        transport</label
      >
      <label
        ><input type="radio" name="needs_transport" value="no" checked /> No, I
        have my own transport</label
      >
    </fieldset>
    <label>
      Describe your situation
      <textarea
        name="notes"
        rows="3"
        placeholder="Tell us about your condition or needs (e.g., mobility, escorts, urgent medication)"
      ></textarea>
    </label>
    <label>
      <input
        type="checkbox"
        name="collect_medication"
        id="collect_medication"
      />
      I need someone to collect/pick up medicines for me
    </label>
    <div class="note">Estimated cost: <span id="priceEstimate">$50</span></div>
    <div id="pickupGroup" style="display: none" class="card" aria-hidden="true">
      <label
        >Pickup address
        <div style="display: flex; gap: 0.5rem; align-items: center">
          <input type="text" name="pickup_address" id="pickup_address" />
          <button type="button" id="useLocation" class="btn small">
            Use my location
          </button>
        </div>
        <input type="hidden" name="pickup_lat" id="pickup_lat" />
        <input type="hidden" name="pickup_lng" id="pickup_lng" />
      </label>
      <p id="etaText" class="note"></p>
      <p id="locNote" class="note" style="display: none"></p>
    </div>
    <div class="form-actions">
      <button class="btn" type="submit" data-wait="Submitting...">
        Submit Request
      </button>
    </div>
  </form>
</div>
<script>
  // Simple client-side logic for showing pickup fields and ETA
  (function () {
    const form = document.getElementById("bookForm");
    const radios = form.elements["needs_transport"];
    const pickup = document.getElementById("pickupGroup");
    const eta = document.getElementById("etaText");
    function update() {
      const selected = Array.from(radios).find((r) => r.checked).value;
      if (selected === "yes") {
        pickup.style.display = "block";
        pickup.setAttribute("aria-hidden", "false");
        document.getElementById("pickup_address").required = true;
        // Simulate estimated pickup time
        const minutes = 10 + Math.floor(Math.random() * 30);
        eta.textContent = "Estimated pickup time: ~" + minutes + " minutes.";
      } else {
        pickup.style.display = "none";
        pickup.setAttribute("aria-hidden", "true");
        document.getElementById("pickup_address").required = false;
        eta.textContent = "";
      }
    }
    Array.from(radios).forEach((r) => r.addEventListener("change", update));
    update();

    // Geolocation helper: fill hidden lat/lng and address marker
    const useBtn = document.getElementById("useLocation");
    const latIn = document.getElementById("pickup_lat");
    const lngIn = document.getElementById("pickup_lng");
    const locNote = document.getElementById("locNote");
    if (useBtn) {
      useBtn.addEventListener("click", (e) => {
        if (!navigator.geolocation) {
          locNote.style.display = "block";
          locNote.textContent = "Geolocation is not supported by your browser.";
          return;
        }
        useBtn.disabled = true;
        useBtn.textContent = "Getting…";
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude.toFixed(6);
            const lng = pos.coords.longitude.toFixed(6);
            latIn.value = lat;
            lngIn.value = lng;
            document.getElementById(
              "pickup_address"
            ).value = `Current location (${lat}, ${lng})`;
            locNote.style.display = "block";
            locNote.textContent = `Using current location — coords: ${lat}, ${lng}`;
            useBtn.disabled = false;
            useBtn.textContent = "Use my location";
          },
          (err) => {
            locNote.style.display = "block";
            locNote.textContent = "Could not get your location: " + err.message;
            useBtn.disabled = false;
            useBtn.textContent = "Use my location";
          },
          { enableHighAccuracy: false, timeout: 10000 }
        );
      });
    }
  })();
</script>
{% endblock %}
